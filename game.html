<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cricket Bidding Game</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB6SH4MULNvPgBgJqUuKEDiC4h88StqxhM",
  authDomain: "cricket-5d616.firebaseapp.com",
  databaseURL: "https://cricket-5d616-default-rtdb.firebaseio.com",
  projectId: "cricket-5d616",
  storageBucket: "cricket-5d616.appspot.com",
  messagingSenderId: "541734533056",
  appId: "1:541734533056:web:7a0f358398fc70272c1f9a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const roomId = new URLSearchParams(location.search).get("room");
const ME = new URLSearchParams(location.search).get("me");
const roomRef = ref(db, "rooms/" + roomId);

let roomData = {};

function log(msg) {
  document.getElementById("log").innerHTML += msg + "<br>";
}

onValue(roomRef, (snap) => {
  if (!snap.exists()) return;
  roomData = snap.val();
  render();
});

function render() {
  const player = roomData.players?.[ME];
  const bidding = roomData.bidding || {};
  const activeFor = bidding.activeFor;
  const pool = roomData.pool || [];
  const currentPlayer = pool.find((x) => x.id === activeFor);

  document.getElementById("pool").innerHTML = pool.map(p => `
    <div>${p.name}</div>
  `).join("");

  document.getElementById("me").innerHTML = `
    <h3>${player.name}</h3>
    <p>Budget: â‚¹${player.budget}</p>
    <p>Squad: ${player.squad?.map(p => p.name).join(", ") || "Empty"}</p>
  `;

  if (!activeFor) {
    document.getElementById("bidding").innerHTML = `<button id="startBidBtn">Start Bidding</button>`;
    document.getElementById("startBidBtn").onclick = startBid;
  } else {
    const current = pool.find(p => p.id === activeFor);
    renderBidding(current);
  }
}

async function startBid() {
  const firstPlayer = (roomData.pool || [])[0];
  if (!firstPlayer) return;
  await update(roomRef, {
    "bidding/activeFor": firstPlayer.id,
    "bidding/bids": {},
    "bidding/roundOpen": true
  });
  log("Bidding started for " + firstPlayer.name);
}

function renderBidding(currentPlayer) {
  const bids = roomData.bidding?.bids || {};
  const myBid = bids[ME]?.amount || 0;
  const opponent = Object.values(bids).find(x => x.uid !== ME && !x.withdrawn);
  const currentBid = opponent ? opponent.amount : 0;

  document.getElementById("bidding").innerHTML = `
    <h3>Bidding for: ${currentPlayer.name}</h3>
    <p>Current highest bid: â‚¹${currentBid}</p>
    <input id="bidAmount" type="number" min="${currentBid + 100}" placeholder="Enter bid" />
    <button id="placeBidBtn">Place Bid</button>
    <button id="withdrawBidBtn" style="margin-left:8px;color:#f55;">Withdraw</button>
  `;

  document.getElementById("placeBidBtn").onclick = async () => {
    const amount = parseInt(document.getElementById("bidAmount").value);
    if (isNaN(amount) || amount <= currentBid) return alert("Invalid bid!");
    const updates = {};
    updates["bidding/bids/" + ME] = {
      uid: ME,
      name: roomData.players[ME].name,
      amount: amount,
      withdrawn: false
    };
    await update(roomRef, updates);
    log(`You bid â‚¹${amount} for ${currentPlayer.name}`);
  };

  // ðŸ”¥ Withdraw System
  document.getElementById("withdrawBidBtn").onclick = async () => {
    const updates = {};
    updates["bidding/bids/" + ME] = {
      uid: ME,
      name: roomData.players[ME].name,
      amount: 0,
      withdrawn: true
    };
    await update(roomRef, updates);
    log("You withdrew from this bid.");

    // check opponent bid
    const bidsNow = roomData.bidding?.bids || {};
    const others = Object.values(bidsNow).filter(x => x.uid !== ME && !x.withdrawn);
    if (others.length > 0) {
      const winner = others[0];
      const playerId = roomData.bidding.activeFor;
      const playerObj = (roomData.pool || []).find(x => x.id === playerId);

      const updates2 = {};
      const wSquad = (roomData.players[winner.uid].squad || []).slice();
      wSquad.push(playerObj);
      const wBudget = roomData.players[winner.uid].budget - winner.amount;

      updates2[`players/${winner.uid}/budget`] = wBudget;
      updates2[`players/${winner.uid}/squad`] = wSquad;
      updates2["bidding/activeFor"] = null;
      updates2["bidding/bids"] = {};
      updates2["bidding/roundOpen"] = false;

      await update(roomRef, updates2);
      log(`${winner.name} got ${playerObj.name} after withdrawal.`);
    } else {
      await update(roomRef, {
        "bidding/activeFor": null,
        "bidding/roundOpen": false
      });
      log("Bidding closed (no other bidder).");
    }
  };
}

</script>
</head>
<body>
  <h1>Cricket Bidding Game</h1>
  <div id="pool"></div>
  <div id="me"></div>
  <div id="bidding"></div>
  <hr>
  <div id="log" style="font-family: monospace; color: #333;"></div>
</body>
</html>
